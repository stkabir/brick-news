---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type CategoryEntry = CollectionEntry<"categories">;
type SectionEntry = CollectionEntry<"sections">;
type ArticleEntry = CollectionEntry<"articles">;

type NavLink = {
  slug: string;
  titleEn: string;
  titleEs: string;
};

type CategoryMeta = {
  titleEn: string;
  titleEs: string;
  accentColor: string;
};

type DateLabels = {
  en: string;
  es: string;
};

type SectionArticle = {
  entry: ArticleEntry;
  categoryMeta: CategoryMeta;
  formattedDate: DateLabels;
};

type SectionGroup = {
  slug: string;
  layout: SectionEntry["data"]["layout"];
  titleEn: string;
  titleEs: string;
  descriptionEn?: string;
  descriptionEs?: string;
  articles: SectionArticle[];
};

const [categoryEntries, sectionEntries, articleEntries] = await Promise.all([
  getCollection("categories"),
  getCollection("sections"),
  getCollection("articles"),
]);

const navLinks: NavLink[] = categoryEntries
  .filter((category: CategoryEntry) => category.data.nav)
  .map((category: CategoryEntry) => ({
    slug: category.slug,
    titleEn: category.data.titleEn,
    titleEs: category.data.titleEs,
  }));

const categoryMap = new Map<string, CategoryEntry>(
  categoryEntries.map((entry: CategoryEntry) => [entry.slug, entry])
);

const getCategoryMeta = (slug: string): CategoryMeta => {
  const entry = categoryMap.get(slug)?.data;
  return {
    titleEn: entry?.titleEn ?? slug,
    titleEs: entry?.titleEs ?? slug,
    accentColor: entry?.accentColor ?? "#8b0000",
  };
};

const dateFormatOptions: Intl.DateTimeFormatOptions = {
  month: "short",
  day: "numeric",
  year: "numeric",
};

const formatDateLabels = (isoDate: string): DateLabels => {
  const date = new Date(isoDate);
  return {
    en: date.toLocaleDateString("en-US", dateFormatOptions),
    es: date.toLocaleDateString("es-ES", dateFormatOptions),
  };
};

const sortArticles = (a: ArticleEntry, b: ArticleEntry) => {
  if (b.data.priority !== a.data.priority) {
    return b.data.priority - a.data.priority;
  }
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
};

const groupedSections: SectionGroup[] = sectionEntries
  .sort((a: SectionEntry, b: SectionEntry) => a.data.order - b.data.order)
  .map((section: SectionEntry): SectionGroup => {
    const sectionArticles: SectionArticle[] = articleEntries
      .filter((article: ArticleEntry) => section.data.categories.includes(article.data.category))
      .sort(sortArticles)
      .map((article: ArticleEntry) => ({
        entry: article,
        categoryMeta: getCategoryMeta(article.data.category),
        formattedDate: formatDateLabels(article.data.date),
      }));

    return {
      slug: section.slug,
      layout: section.data.layout,
      titleEn: section.data.titleEn,
      titleEs: section.data.titleEs,
      descriptionEn: section.data.descriptionEn,
      descriptionEs: section.data.descriptionEs,
      articles: sectionArticles,
    };
  });

const heroSection = groupedSections.find((section) => section.layout === "hero");
const nonHeroSections = groupedSections.filter((section) => section.layout !== "hero");

const heroArticle = heroSection?.articles[0];
const heroEntry = heroArticle?.entry;
const heroCategoryMeta = heroArticle?.categoryMeta;
const heroDateLabels = heroArticle?.formattedDate;

const gridSection = nonHeroSections.find((s) => s.layout === "grid");
const gridArticles = gridSection?.articles ?? [];
const frontSidebar = gridArticles
  .filter((a) => a.entry.slug !== heroEntry?.slug)
  .slice(0, 3);

const trendingFeatured = gridArticles[0];
const trendingRest = gridArticles.slice(1, 4);
---

<BaseLayout
  navLinks={navLinks}
  pageTitle="Brickell News | Noticias Brickell"
  descriptionEn="Your bilingual hub for Brickell's headlines, business, lifestyle, and events."
  descriptionEs="Tu centro bilingüe para titulares, negocios, estilo de vida y eventos de Brickell."
>

  <!-- ════════════════════════════════════════════════════
       FRONT PAGE — Above the Fold
       ════════════════════════════════════════════════════ -->
  {heroSection && heroEntry ? (
    <section id={heroSection.slug} class="grid grid-cols-1 lg:grid-cols-[1fr_320px] gap-0 pb-8 border-b border-rule-light reveal">

      <!-- Main Story -->
      <div class="lg:pr-8 lg:border-r lg:border-rule-light">
        <img
          src={heroEntry.data.image}
          alt={heroEntry.data.titleEn}
          class="w-full h-[280px] sm:h-[360px] object-cover"
          loading="eager"
        />
        <div class="pt-5">
          <p class="font-label text-[10px] font-bold uppercase tracking-[0.25em] text-accent">
            <span class="lang lang-en">{heroCategoryMeta?.titleEn}</span>
            <span class="lang lang-es">{heroCategoryMeta?.titleEs}</span>
          </p>
          <h2 class="mt-2 font-headline text-3xl sm:text-4xl lg:text-5xl font-black leading-[1.1]">
            <span class="lang lang-en">{heroEntry.data.titleEn}</span>
            <span class="lang lang-es">{heroEntry.data.titleEs}</span>
          </h2>
          <p class="mt-4 text-lg leading-relaxed text-ink-light font-article drop-cap">
            <span class="lang lang-en">{heroEntry.data.summaryEn}</span>
            <span class="lang lang-es">{heroEntry.data.summaryEs}</span>
          </p>
          <p class="mt-4 font-label text-[10px] uppercase tracking-[0.18em] text-ink-faded">
            <span class="lang lang-en">By {heroEntry.data.author} &mdash; {heroDateLabels?.en}</span>
            <span class="lang lang-es">Por {heroEntry.data.author} &mdash; {heroDateLabels?.es}</span>
          </p>
        </div>
      </div>

      <!-- Front-Page Sidebar -->
      <aside class="lg:pl-8 pt-6 lg:pt-0">
        <p class="font-label text-[9px] font-bold uppercase tracking-[0.35em] text-ink-faded border-b border-rule pb-2 mb-0">
          <span class="lang lang-en">Also in this edition</span>
          <span class="lang lang-es">También en esta edición</span>
        </p>
        {frontSidebar.map(({ entry, categoryMeta, formattedDate }) => (
          <article class="group py-4 border-b border-rule-light last:border-b-0">
            <p class="font-label text-[9px] font-bold uppercase tracking-[0.25em] text-accent">
              <span class="lang lang-en">{categoryMeta.titleEn}</span>
              <span class="lang lang-es">{categoryMeta.titleEs}</span>
            </p>
            <h3 class="mt-1 font-headline text-lg font-bold leading-snug transition-colors group-hover:text-accent">
              <span class="lang lang-en">{entry.data.titleEn}</span>
              <span class="lang lang-es">{entry.data.titleEs}</span>
            </h3>
            <p class="mt-1.5 text-sm text-ink-light leading-relaxed line-clamp-2">
              <span class="lang lang-en">{entry.data.summaryEn}</span>
              <span class="lang lang-es">{entry.data.summaryEs}</span>
            </p>
            <p class="mt-2 font-label text-[9px] uppercase tracking-[0.15em] text-ink-faded">
              <span class="lang lang-en">{entry.data.author} &mdash; {formattedDate.en}</span>
              <span class="lang lang-es">{entry.data.author} &mdash; {formattedDate.es}</span>
            </p>
          </article>
        ))}
      </aside>

    </section>
  ) : null}


  <!-- ════════════════════════════════════════════════════
       SECTION DIVIDER
       ════════════════════════════════════════════════════ -->
  <div class="flex items-center gap-4 my-8" role="separator" aria-hidden="true">
    <div class="flex-1 border-t border-rule"></div>
    <span class="text-rule-light text-sm leading-none select-none">&#9670;</span>
    <div class="flex-1 border-t border-rule"></div>
  </div>


  <!-- ════════════════════════════════════════════════════
       TRENDING DEVELOPMENTS
       ════════════════════════════════════════════════════ -->
  {gridSection && gridArticles.length > 0 ? (
    <section id={gridSection.slug} class="reveal">
      <h2 class="font-headline text-xl sm:text-2xl text-center border-y-2 border-rule py-2 mb-8 uppercase tracking-[0.12em]">
        <span class="lang lang-en">{gridSection.titleEn}</span>
        <span class="lang lang-es">{gridSection.titleEs}</span>
      </h2>

      <!-- Featured Article -->
      {trendingFeatured && (
        <article class="group grid grid-cols-1 md:grid-cols-2 gap-6 pb-8 border-b border-rule-light">
          <img
            src={trendingFeatured.entry.data.image}
            alt={trendingFeatured.entry.data.titleEn}
            class="w-full h-56 md:h-72 object-cover newspaper-img"
            loading="lazy"
          />
          <div class="flex flex-col justify-center">
            <p class="font-label text-[10px] font-bold uppercase tracking-[0.25em] text-accent">
              <span class="lang lang-en">{trendingFeatured.categoryMeta.titleEn}</span>
              <span class="lang lang-es">{trendingFeatured.categoryMeta.titleEs}</span>
            </p>
            <h3 class="mt-2 font-headline text-2xl sm:text-3xl font-bold leading-snug transition-colors group-hover:text-accent">
              <span class="lang lang-en">{trendingFeatured.entry.data.titleEn}</span>
              <span class="lang lang-es">{trendingFeatured.entry.data.titleEs}</span>
            </h3>
            <p class="mt-3 text-ink-light leading-relaxed">
              <span class="lang lang-en">{trendingFeatured.entry.data.summaryEn}</span>
              <span class="lang lang-es">{trendingFeatured.entry.data.summaryEs}</span>
            </p>
            <p class="mt-4 font-label text-[10px] uppercase tracking-[0.18em] text-ink-faded">
              <span class="lang lang-en">By {trendingFeatured.entry.data.author} &mdash; {trendingFeatured.formattedDate.en}</span>
              <span class="lang lang-es">Por {trendingFeatured.entry.data.author} &mdash; {trendingFeatured.formattedDate.es}</span>
            </p>
          </div>
        </article>
      )}

      <!-- Column Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 divide-y sm:divide-y-0 sm:divide-x divide-rule-light pt-6">
        {trendingRest.map(({ entry, categoryMeta, formattedDate }, i) => (
          <article class={`group px-0 sm:px-5 py-4 sm:py-0 ${i === 0 ? 'sm:pl-0' : ''} ${i === trendingRest.length - 1 ? 'sm:pr-0' : ''}`}>
            <img
              src={entry.data.image}
              alt={entry.data.titleEn}
              class="w-full h-44 object-cover newspaper-img"
              loading="lazy"
            />
            <p class="mt-3 font-label text-[9px] font-bold uppercase tracking-[0.25em] text-accent">
              <span class="lang lang-en">{categoryMeta.titleEn}</span>
              <span class="lang lang-es">{categoryMeta.titleEs}</span>
            </p>
            <h3 class="mt-1 font-headline text-lg font-bold leading-snug transition-colors group-hover:text-accent">
              <span class="lang lang-en">{entry.data.titleEn}</span>
              <span class="lang lang-es">{entry.data.titleEs}</span>
            </h3>
            <p class="mt-2 text-sm text-ink-light leading-relaxed line-clamp-3">
              <span class="lang lang-en">{entry.data.summaryEn}</span>
              <span class="lang lang-es">{entry.data.summaryEs}</span>
            </p>
            <p class="mt-3 font-label text-[9px] uppercase tracking-[0.15em] text-ink-faded">
              <span class="lang lang-en">{entry.data.author} &mdash; {formattedDate.en}</span>
              <span class="lang lang-es">{entry.data.author} &mdash; {formattedDate.es}</span>
            </p>
          </article>
        ))}
      </div>
    </section>
  ) : null}


  <!-- ════════════════════════════════════════════════════
       SECTION DIVIDER
       ════════════════════════════════════════════════════ -->
  <div class="flex items-center gap-4 my-8" role="separator" aria-hidden="true">
    <div class="flex-1 border-t border-rule"></div>
    <span class="text-rule-light text-sm leading-none select-none">&#9670;</span>
    <div class="flex-1 border-t border-rule"></div>
  </div>


  <!-- ════════════════════════════════════════════════════
       LATEST UPDATES + LIVING IN BRICKELL (Sidebar)
       ════════════════════════════════════════════════════ -->
  <section class="grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-0 reveal">

    <!-- Latest Updates (left column) -->
    <div class="lg:pr-8 lg:border-r lg:border-rule-light">
      {nonHeroSections
        .filter((section) => section.layout === "list")
        .map((section) => (
          <div id={section.slug}>
            <h2 class="font-headline text-xl uppercase tracking-[0.1em] border-b-2 border-rule pb-2 mb-0">
              <span class="lang lang-en">{section.titleEn}</span>
              <span class="lang lang-es">{section.titleEs}</span>
            </h2>
            {section.descriptionEn && (
              <p class="mt-2 text-sm text-ink-faded font-article italic">
                <span class="lang lang-en">{section.descriptionEn}</span>
                <span class="lang lang-es">{section.descriptionEs}</span>
              </p>
            )}
            <div class="divide-y divide-rule-light">
              {section.articles.slice(0, 5).map(({ entry, categoryMeta, formattedDate }) => (
                <article class="group flex flex-col sm:flex-row gap-4 py-5">
                  <img
                    src={entry.data.image}
                    alt={entry.data.titleEn}
                    class="w-full sm:w-28 h-28 sm:h-24 object-cover flex-shrink-0 newspaper-img"
                    loading="lazy"
                  />
                  <div class="flex-1 min-w-0">
                    <p class="font-label text-[9px] font-bold uppercase tracking-[0.25em] text-accent">
                      <span class="lang lang-en">{categoryMeta.titleEn}</span>
                      <span class="lang lang-es">{categoryMeta.titleEs}</span>
                    </p>
                    <h3 class="mt-1 font-headline text-lg font-bold leading-snug transition-colors group-hover:text-accent">
                      <span class="lang lang-en">{entry.data.titleEn}</span>
                      <span class="lang lang-es">{entry.data.titleEs}</span>
                    </h3>
                    <p class="mt-1 text-sm text-ink-light leading-relaxed line-clamp-2">
                      <span class="lang lang-en">{entry.data.summaryEn}</span>
                      <span class="lang lang-es">{entry.data.summaryEs}</span>
                    </p>
                    <p class="mt-2 font-label text-[9px] uppercase tracking-[0.15em] text-ink-faded">
                      <span class="lang lang-en">{entry.data.author} &mdash; {formattedDate.en}</span>
                      <span class="lang lang-es">{entry.data.author} &mdash; {formattedDate.es}</span>
                    </p>
                  </div>
                </article>
              ))}
            </div>
          </div>
        ))}

      <!-- Classified Ad -->
      <div class="border-2 border-dashed border-rule-light p-6 text-center my-6">
        <p class="font-label text-[9px] font-bold uppercase tracking-[0.35em] text-ink-faded">
          <span class="lang lang-en">Advertisement</span>
          <span class="lang lang-es">Publicidad</span>
        </p>
        <p class="mt-2 text-sm text-ink-faded font-article italic">
          <span class="lang lang-en">Feature a local business or community event here.</span>
          <span class="lang lang-es">Destaca un negocio local o evento comunitario aquí.</span>
        </p>
      </div>
    </div>

    <!-- Living in Brickell (right sidebar) -->
    <aside class="lg:pl-8 pt-6 lg:pt-0">
      {nonHeroSections
        .filter((section) => section.layout === "sidebar")
        .map((section) => (
          <div id={section.slug}>
            <h2 class="font-headline text-xl uppercase tracking-[0.1em] border-b-2 border-rule pb-2 mb-0">
              <span class="lang lang-en">{section.titleEn}</span>
              <span class="lang lang-es">{section.titleEs}</span>
            </h2>
            {section.descriptionEn && (
              <p class="mt-2 text-sm text-ink-faded font-article italic">
                <span class="lang lang-en">{section.descriptionEn}</span>
                <span class="lang lang-es">{section.descriptionEs}</span>
              </p>
            )}
            <div class="divide-y divide-rule-light">
              {section.articles.slice(0, 4).map(({ entry, categoryMeta, formattedDate }) => (
                <article class="group py-5">
                  <img
                    src={entry.data.image}
                    alt={entry.data.titleEn}
                    class="w-full h-44 object-cover newspaper-img"
                    loading="lazy"
                  />
                  <p class="mt-3 font-label text-[9px] font-bold uppercase tracking-[0.25em] text-accent">
                    <span class="lang lang-en">{categoryMeta.titleEn}</span>
                    <span class="lang lang-es">{categoryMeta.titleEs}</span>
                  </p>
                  <h3 class="mt-1 font-headline text-lg font-bold leading-snug transition-colors group-hover:text-accent">
                    <span class="lang lang-en">{entry.data.titleEn}</span>
                    <span class="lang lang-es">{entry.data.titleEs}</span>
                  </h3>
                  <p class="mt-1.5 text-sm text-ink-light leading-relaxed line-clamp-3">
                    <span class="lang lang-en">{entry.data.summaryEn}</span>
                    <span class="lang lang-es">{entry.data.summaryEs}</span>
                  </p>
                  <p class="mt-2 font-label text-[9px] uppercase tracking-[0.15em] text-ink-faded">
                    <span class="lang lang-en">{entry.data.author} &mdash; {formattedDate.en}</span>
                    <span class="lang lang-es">{entry.data.author} &mdash; {formattedDate.es}</span>
                  </p>
                </article>
              ))}
            </div>
          </div>
        ))}
    </aside>

  </section>

</BaseLayout>
