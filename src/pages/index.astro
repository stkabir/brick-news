---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type CategoryEntry = CollectionEntry<"categories">;
type SectionEntry = CollectionEntry<"sections">;
type ArticleEntry = CollectionEntry<"articles">;

type NavLink = { slug: string; titleEn: string; titleEs: string };
type CategoryMeta = { titleEn: string; titleEs: string; accentColor: string };
type DateLabels = { en: string; es: string };
type EnrichedArticle = {
  entry: ArticleEntry;
  categoryMeta: CategoryMeta;
  formattedDate: DateLabels;
};

const [categoryEntries, sectionEntries, articleEntries] = await Promise.all([
  getCollection("categories"),
  getCollection("sections"),
  getCollection("articles"),
]);

const navLinks: NavLink[] = categoryEntries
  .filter((c: CategoryEntry) => c.data.nav)
  .map((c: CategoryEntry) => ({
    slug: c.slug,
    titleEn: c.data.titleEn,
    titleEs: c.data.titleEs,
  }));

const categoryMap = new Map<string, CategoryEntry>(
  categoryEntries.map((e: CategoryEntry) => [e.slug, e])
);

const getCategoryMeta = (slug: string): CategoryMeta => {
  const d = categoryMap.get(slug)?.data;
  return {
    titleEn: d?.titleEn ?? slug,
    titleEs: d?.titleEs ?? slug,
    accentColor: d?.accentColor ?? "#48d1d1",
  };
};

const dateOpts: Intl.DateTimeFormatOptions = {
  month: "short",
  day: "numeric",
  year: "numeric",
};

const formatDate = (iso: string): DateLabels => {
  const d = new Date(iso);
  return {
    en: d.toLocaleDateString("en-US", dateOpts).toUpperCase(),
    es: d.toLocaleDateString("es-ES", dateOpts).toUpperCase(),
  };
};

const sortArticles = (a: ArticleEntry, b: ArticleEntry) => {
  if (b.data.priority !== a.data.priority) return b.data.priority - a.data.priority;
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
};

const enrichArticle = (a: ArticleEntry): EnrichedArticle => ({
  entry: a,
  categoryMeta: getCategoryMeta(a.data.category),
  formattedDate: formatDate(a.data.date),
});

// All articles sorted by priority
const allArticles = [...articleEntries].sort(sortArticles).map(enrichArticle);

// Sections grouped by layout
const groupedSections = sectionEntries
  .sort((a: SectionEntry, b: SectionEntry) => a.data.order - b.data.order)
  .map((s: SectionEntry) => ({
    slug: s.slug,
    layout: s.data.layout,
    titleEn: s.data.titleEn,
    titleEs: s.data.titleEs,
    descriptionEn: s.data.descriptionEn,
    descriptionEs: s.data.descriptionEs,
    articles: articleEntries
      .filter((a: ArticleEntry) => s.data.categories.includes(a.data.category))
      .sort(sortArticles)
      .map(enrichArticle),
  }));

const trendingSection = groupedSections.find((s) => s.layout === "grid");
const trendingArticles = trendingSection?.articles || [];

// Unique category tabs for trending
const seenCats = new Set<string>();
const trendingTabs = trendingArticles
  .filter((a) => {
    if (seenCats.has(a.entry.data.category)) return false;
    seenCats.add(a.entry.data.category);
    return true;
  })
  .map((a) => a.categoryMeta);

// Banner article (first business article)
const bannerArticle =
  allArticles.find((a) => a.entry.data.category === "business") || allArticles[2];

// More news: list + sidebar sections
const listSection = groupedSections.find((s) => s.layout === "list");
const sidebarSection = groupedSections.find((s) => s.layout === "sidebar");
const moreListArticles = [
  ...(listSection?.articles || []),
  ...(sidebarSection?.articles || []),
].slice(0, 8);
const moreFeatureArticle = sidebarSection?.articles[0] || allArticles[3];
const moreRightArticles = (sidebarSection?.articles || []).slice(1, 4);
---

<BaseLayout
  navLinks={navLinks}
  pageTitle="Brickell News | Noticias Brickell"
  descriptionEn="Your bilingual hub for Brickell's headlines, business, lifestyle, and events."
  descriptionEs="Tu centro bilingüe para titulares, negocios, estilo de vida y eventos de Brickell."
>

  <!-- ══════ HERO ══════ -->
  <div class="container hero-section">
    <div class="hero-grid">

      <!-- Left: Featured -->
      {allArticles[0] && (
        <div class="story-featured">
          <span class="badge-breaking">
            <span class="lang lang-en">Breaking News</span>
            <span class="lang lang-es">Últimas novedades</span>
          </span>
          <h1>
            <span class="lang lang-en">{allArticles[0].entry.data.titleEn}</span>
            <span class="lang lang-es">{allArticles[0].entry.data.titleEs}</span>
          </h1>
          <img
            src={allArticles[0].entry.data.image}
            alt={allArticles[0].entry.data.titleEn}
            style="width:100%;height:200px;border-radius:6px;margin-bottom:12px;object-fit:cover;"
          />
          <p>
            <span class="lang lang-en">{allArticles[0].entry.data.summaryEn}</span>
            <span class="lang lang-es">{allArticles[0].entry.data.summaryEs}</span>
          </p>
        </div>
      )}

      <!-- Center -->
      {allArticles[1] && (
        <div class="story-center">
          <img
            src={allArticles[1].entry.data.image}
            alt={allArticles[1].entry.data.titleEn}
            style="width:100%;height:170px;border-radius:6px;margin-bottom:10px;object-fit:cover;"
          />
          <h3>
            <span class="lang lang-en">{allArticles[1].entry.data.titleEn}</span>
            <span class="lang lang-es">{allArticles[1].entry.data.titleEs}</span>
          </h3>
          <div class="sub-stories">
            {allArticles.slice(2, 4).map((article) => (
              <div class="sub-story">
                <img
                  src={article.entry.data.image}
                  alt={article.entry.data.titleEn}
                  style="width:100%;height:80px;border-radius:4px;margin-bottom:6px;object-fit:cover;"
                />
                <p>
                  <span class="lang lang-en">{article.entry.data.titleEn}</span>
                  <span class="lang lang-es">{article.entry.data.titleEs}</span>
                </p>
              </div>
            ))}
          </div>
        </div>
      )}

      <!-- Right -->
      <div class="story-right">
        {allArticles.slice(4, 6).map((article) => (
          <div class="top-story">
            <img
              src={article.entry.data.image}
              alt={article.entry.data.titleEn}
              style="width:100px;height:70px;border-radius:4px;flex-shrink:0;object-fit:cover;"
            />
            <div class="top-story-text">
              <h4>
                <span class="lang lang-en">{article.entry.data.titleEn}</span>
                <span class="lang lang-es">{article.entry.data.titleEs}</span>
              </h4>
              <p>
                <span class="lang lang-en">{article.entry.data.summaryEn}</span>
                <span class="lang lang-es">{article.entry.data.summaryEs}</span>
              </p>
            </div>
          </div>
        ))}
        <ul class="side-list">
          {allArticles.slice(6, 10).map((article) => (
            <li>
              <span class="lang lang-en">{article.entry.data.titleEn}</span>
              <span class="lang lang-es">{article.entry.data.titleEs}</span>
            </li>
          ))}
        </ul>
      </div>

    </div>
  </div>

  <!-- ══════ BANNER ══════ -->
  {bannerArticle && (
    <div class="container">
      <div class="feature-banner">
        <video class="banner-bg" src="/img/vid-brickell.mp4" autoplay loop muted playsinline></video>
        <div class="banner-content">
          <div>
            <span class="banner-cat">
              <span class="lang lang-en">{bannerArticle.categoryMeta.titleEn}</span>
              <span class="lang lang-es">{bannerArticle.categoryMeta.titleEs}</span>
            </span>
            <span class="banner-date">
              <span class="lang lang-en">{bannerArticle.formattedDate.en}</span>
              <span class="lang lang-es">{bannerArticle.formattedDate.es}</span>
            </span>
          </div>
          <h2>
            <span class="lang lang-en">{bannerArticle.entry.data.titleEn}</span>
            <span class="lang lang-es">{bannerArticle.entry.data.titleEs}</span>
          </h2>
          <p>
            <span class="lang lang-en">{bannerArticle.entry.data.summaryEn}</span>
            <span class="lang lang-es">{bannerArticle.entry.data.summaryEs}</span>
          </p>
          <a href="#" class="btn-read">
            <span class="lang lang-en">Read Story &#9658;</span>
            <span class="lang lang-es">Leer Historia &#9658;</span>
          </a>
        </div>
      </div>
    </div>
  )}

  <!-- ══════ MORE NEWS ══════ -->
  <div class="container more-section">
    <h2 class="section-title">
      <span class="lang lang-en">More News</span>
      <span class="lang lang-es">Más noticias</span>
    </h2>
    <div class="more-grid">

      <!-- Left list -->
      <div class="more-list">
        {moreListArticles.map((article) => (
          <div class="more-list-item">
            <img
              src={article.entry.data.image}
              alt={article.entry.data.titleEn}
              style="width:60px;height:48px;border-radius:4px;flex-shrink:0;object-fit:cover;"
            />
            <p>
              <span class="lang lang-en">{article.entry.data.titleEn}</span>
              <span class="lang lang-es">{article.entry.data.titleEs}</span>
            </p>
          </div>
        ))}
      </div>

      <!-- Center feature -->
      {moreFeatureArticle && (
        <div class="more-feature">
          <img
            src={moreFeatureArticle.entry.data.image}
            alt={moreFeatureArticle.entry.data.titleEn}
            style="width:100%;height:200px;border-radius:8px;margin-bottom:14px;object-fit:cover;"
          />
          <h3>
            <span class="lang lang-en">{moreFeatureArticle.entry.data.titleEn}</span>
            <span class="lang lang-es">{moreFeatureArticle.entry.data.titleEs}</span>
          </h3>
          <p>
            <span class="lang lang-en">{moreFeatureArticle.entry.data.summaryEn}</span>
            <span class="lang lang-es">{moreFeatureArticle.entry.data.summaryEs}</span>
          </p>
        </div>
      )}

      <!-- Right -->
      <div class="more-right">
        {moreRightArticles.map((article, i) => (
          <div class="more-right-item" style={i > 0 ? "padding-top:14px;" : ""}>
            {i === 0 && (
              <img
                src={article.entry.data.image}
                alt={article.entry.data.titleEn}
                style="width:100%;height:70px;border-radius:4px;margin-bottom:8px;object-fit:cover;"
              />
            )}
            <h4>
              <span class="lang lang-en">{article.entry.data.titleEn}</span>
              <span class="lang lang-es">{article.entry.data.titleEs}</span>
            </h4>
            {i === 0 && (
              <p>
                <span class="lang lang-en">{article.entry.data.summaryEn}</span>
                <span class="lang lang-es">{article.entry.data.summaryEs}</span>
              </p>
            )}
          </div>
        ))}
      </div>

    </div>
  </div>

  <!-- ══════ TRENDING CAROUSEL ══════ -->
  <div class="trending-section">
    <div class="container">
      <div class="trending-header">
        <div>
          <p class="trending-label">
            <span class="lang lang-en">{trendingSection?.titleEn || "Trending Developments"}</span>
            <span class="lang lang-es">{trendingSection?.titleEs || "Desarrollos en Tendencia"}</span>
          </p>
          <p class="trending-subtitle">
            <span class="lang lang-en">{trendingSection?.descriptionEn || "The projects and deals shaping Brickell's skyline."}</span>
            <span class="lang lang-es">{trendingSection?.descriptionEs || "Los proyectos y acuerdos que moldean el horizonte de Brickell."}</span>
          </p>
        </div>
        <div class="trending-tabs">
          {trendingTabs.map((tab, i) => (
            <span class={`tab${i === 0 ? " active" : ""}`}>
              <span class="lang lang-en">{tab.titleEn}</span>
              <span class="lang lang-es">{tab.titleEs}</span>
            </span>
          ))}
        </div>
      </div>

      <div class="splide" id="trendingSlider">
        <div class="splide__track">
          <ul class="splide__list">
            {trendingArticles.map((article) => (
              <li class="splide__slide">
                <div class="trend-card">
                  <div class="trend-card-img">
                    <img
                      src={article.entry.data.image}
                      alt={article.entry.data.titleEn}
                      loading="lazy"
                    />
                    <span class="card-badge">
                      <span class="lang lang-en">{article.categoryMeta.titleEn}</span>
                      <span class="lang lang-es">{article.categoryMeta.titleEs}</span>
                    </span>
                  </div>
                  <div class="trend-card-body">
                    <h4>
                      <span class="lang lang-en">{article.entry.data.titleEn}</span>
                      <span class="lang lang-es">{article.entry.data.titleEs}</span>
                    </h4>
                    <p>
                      <span class="lang lang-en">{article.entry.data.summaryEn}</span>
                      <span class="lang lang-es">{article.entry.data.summaryEs}</span>
                    </p>
                  </div>
                </div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    import Splide from '@splidejs/splide';
    import '@splidejs/splide/css';

    const slider = new Splide('#trendingSlider', {
      type: 'loop',
      perPage: 3,
      perMove: 3,
      gap: '20px',
      pagination: true,
      arrows: true,
      breakpoints: {
        768: { perPage: 1 },
      },
    });

    slider.mount();

    // Tab toggle
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        slider.go(0);
      });
    });
  </script>

</BaseLayout>
