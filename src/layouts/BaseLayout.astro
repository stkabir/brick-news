---
import "../styles/global.css";

interface NavLink {
  slug: string;
  titleEn: string;
  titleEs: string;
}

interface Props {
  navLinks: NavLink[];
  pageTitle?: string;
  descriptionEn?: string;
  descriptionEs?: string;
}

const {
  navLinks,
  pageTitle = "Brickell News",
  descriptionEn = "Your local source for Brickell news.",
  descriptionEs = "Tu fuente local de noticias de Brickell.",
} = Astro.props;

const now = new Date();
const dateEn = now.toLocaleDateString("en-US", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});
const dateEs = now.toLocaleDateString("es-ES", {
  weekday: "long",
  year: "numeric",
  month: "long",
  day: "numeric",
});
---
<html lang="en" data-locale="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={descriptionEn} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Sans+3:wght@400;600;700&family=Montserrat:wght@700;800;900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <header>
      <div class="header-inner">
        <a href="/" class="logo-wrap">
          <img src="/img/logo.jpeg" alt="Brickell News" class="logo-img" />
        </a>

        <nav>
          <a href="/">
            <span class="lang lang-en">Home</span>
            <span class="lang lang-es">Inicio</span>
          </a>
          {navLinks.filter(l => l.slug !== 'home').map(link => (
            <a href={`/${link.slug}`}>
              <span class="lang lang-en">{link.titleEn}</span>
              <span class="lang lang-es">{link.titleEs}</span>
            </a>
          ))}
        </nav>

        <div class="header-right">
          <input type="text" class="search-box" id="searchBox" placeholder="Search Brickell…" autocomplete="off" />
          <div class="search-dropdown" id="searchDropdown"></div>
          <button class="btn-lang" data-lang-toggle>
            <span class="lang lang-en">ES</span>
            <span class="lang lang-es">EN</span>
          </button>
        </div>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <div class="newsletter">
      <div class="newsletter-inner">
        <div>
          <h3>
            <span class="lang lang-en">Stay connected to Brickell</span>
            <span class="lang lang-es">Mantente conectado con Brickell</span>
          </h3>
          <p>
            <span class="lang lang-en">Weekly highlights delivered in English and Spanish.</span>
            <span class="lang lang-es">Destacados semanales en inglés y español.</span>
          </p>
        </div>
        <div class="newsletter-form">
          <input type="email" placeholder="hello@brickell.news" />
          <button class="btn-subscribe">
            <span class="lang lang-en">Subscribe</span>
            <span class="lang lang-es">Suscribirse</span>
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="footer-contact">
        <a href="mailto:editor@brickell.news" title="editor@brickell.news">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
        </a>
        <a href="https://wa.me/5491133839797" target="_blank" rel="noopener" title="WhatsApp +54 9 11 3383-9797">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413z"/></svg>
        </a>
        <a href="https://instagram.com/brickell.news" target="_blank" rel="noopener" title="@brickell.news">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="5"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor" stroke="none"/></svg>
        </a>
      </div>
      <div class="footer-copy">
        <span class="lang lang-en">&copy; {new Date().getFullYear()} Brickell News</span>
        <span class="lang lang-es">&copy; {new Date().getFullYear()} Noticias Brickell</span>
      </div>
    </footer>


    <script is:inline>
      const storageKey = "brickell-news-locale";
      const root = document.documentElement;
      const toggleButton = document.querySelector('[data-lang-toggle]');
      const searchBox = document.getElementById('searchBox');

      const setLocale = (locale) => {
        if (!['en', 'es'].includes(locale)) locale = 'en';
        root.dataset.locale = locale;
        root.lang = locale;
        if (searchBox) {
          searchBox.placeholder = locale === 'en' ? 'Search Brickell\u2026' : 'Buscar en Brickell\u2026';
        }
      };

      const saved = localStorage.getItem(storageKey);
      if (saved) setLocale(saved);

      toggleButton?.addEventListener('click', () => {
        const next = root.dataset.locale === 'en' ? 'es' : 'en';
        setLocale(next);
        localStorage.setItem(storageKey, next);
      });

      // ——— Search ———
      const searchInput = document.getElementById('searchBox');
      const dropdown = document.getElementById('searchDropdown');
      let articles = null;
      let debounceTimer = null;

      async function loadArticles() {
        if (articles) return articles;
        const res = await fetch('/api/search.json');
        articles = await res.json();
        return articles;
      }

      function getLocale() {
        return root.dataset.locale || 'en';
      }

      function searchArticles(query, data) {
        const q = query.toLowerCase().trim();
        if (!q) return [];
        return data.filter(function(a) {
          return a.titleEn.toLowerCase().includes(q)
            || a.titleEs.toLowerCase().includes(q)
            || a.summaryEn.toLowerCase().includes(q)
            || a.summaryEs.toLowerCase().includes(q)
            || a.author.toLowerCase().includes(q);
        }).slice(0, 6);
      }

      function renderResults(results) {
        const locale = getLocale();
        const isEn = locale === 'en';

        if (results.length === 0) {
          dropdown.innerHTML = '<div class="search-empty">' + (isEn ? 'No results found' : 'Sin resultados') + '</div>';
          dropdown.classList.add('active');
          return;
        }

        dropdown.innerHTML = results.map(function(a) {
          var title = isEn ? a.titleEn : a.titleEs;
          var cat = isEn ? a.categoryEn : a.categoryEs;
          return '<a class="search-dropdown-item" href="/' + a.category + '/' + a.id + '">'
            + '<img src="' + a.image + '&w=120&h=90" alt="" />'
            + '<div class="search-dropdown-info">'
            + '<h4>' + title + '</h4>'
            + '<div class="search-dropdown-meta">'
            + '<span class="search-dropdown-cat">' + cat + '</span>'
            + '<span class="search-dropdown-author">' + a.author + '</span>'
            + '</div></div></a>';
        }).join('');
        dropdown.classList.add('active');
      }

      function hideDropdown() {
        dropdown.classList.remove('active');
        dropdown.innerHTML = '';
      }

      if (searchInput && dropdown) {
        searchInput.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          var val = searchInput.value;
          if (!val.trim()) { hideDropdown(); return; }
          debounceTimer = setTimeout(async function() {
            var data = await loadArticles();
            var results = searchArticles(val, data);
            renderResults(results);
          }, 250);
        });

        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') { hideDropdown(); searchInput.blur(); }
        });

        document.addEventListener('click', function(e) {
          if (!e.target.closest('.header-right')) hideDropdown();
        });
      }
    </script>
  </body>
</html>
